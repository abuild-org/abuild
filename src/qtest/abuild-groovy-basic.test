#!/usr/bin/env perl

require 5.008;
BEGIN { $^W = 1; }
use strict;

require TestDriver;
require abuild_test_utils;

chdir("abuild-groovy-basic") or die;

my $td = new TestDriver("basic groovy");
test_setup();

my $top = get_top();
my $filters = get_filters();
my ($test_java, $test_junit, $jar, $java) = @{get_java_information()};

if (! $test_java)
{
    $td->runtest("skipping groovy tests",
		 {$td->STRING => "skip"},
		 {$td->STRING => "skip"});
    fake_qtc($td, '^(JavaBuilder|groovy)');
    $td->report(1);
    exit 0;
}

# This test contains basic groovy-specific functionality tests

setup($td);

cd("work/util");

$td->runtest("groovy Util",
	     {$td->COMMAND => "abuild",
	      $td->FILTER => "perl $filters/filter-abuild.pl"},
	     {$td->STRING => "abuild: util (abuild-indep): all\n"  .
		  "assertions passed\n",
	      $td->EXIT_STATUS => 0},
	     $td->NORMALIZE_NEWLINES);

cd("work/dynamic");

$td->runtest("no qtest.log",
	     {$td->STRING => (-f "abuild-indep/qtest.log" ? "yes" : "no")},
	     {$td->STRING => "no"});

$td->runtest("groovy dynamic file build",
	     {$td->COMMAND => ['abuild', 'potato.salad=one two three',
			       'check'],
	      $td->FILTER => "perl $filters/filter-abuild.pl"},
	     {$td->FILE => "$top/groovy-dynamic-run.out",
	      $td->EXIT_STATUS => 0},
	     $td->NORMALIZE_NEWLINES);

$td->runtest("qtest.log existence",
	     {$td->STRING => (-f "abuild-indep/qtest.log" ? "yes" : "no")},
	     {$td->STRING => "yes"});

$td->runtest("groovy dynamic file",
	     {$td->FILE => "abuild-indep/.ab-dynamic.groovy",
	      $td->FILTER => "perl $filters/filter-abuild.pl"},
	     {$td->FILE => "$top/groovy-dynamic.out"},
	     $td->NORMALIZE_NEWLINES);

cd("work/force-exit");

$td->runtest("JavaBuilder exit",
	     {$td->COMMAND => "abuild -b all -k",
	      $td->FILTER =>
		  "perl $top/filter-exit.pl | perl $filters/filter-abuild.pl"},
	     {$td->FILE => "$top/force-exit.out",
	      $td->EXIT_STATUS => 2},
	     $td->NORMALIZE_NEWLINES);

cd("work/failures");

$td->runtest("build failures",
	     {$td->COMMAND => "abuild -b all -k",
	      $td->FILTER =>
		  "perl $filters/filter-abuild.pl"},
	     {$td->FILE => "$top/failures.out",
	      $td->EXIT_STATUS => 2},
	     $td->NORMALIZE_NEWLINES);

$td->runtest("build failures without -k",
	     {$td->COMMAND => "abuild -b all",
	      $td->FILTER =>
		  "perl $filters/filter-abuild.pl"},
	     {$td->FILE => "$top/failures-no-k.out",
	      $td->EXIT_STATUS => 2},
	     $td->NORMALIZE_NEWLINES);

cd("work/rules/user");

$td->runtest("basic rule loading",
	     {$td->COMMAND => "abuild -d",
	      $td->FILTER => "perl $filters/filter-abuild.pl"},
	     {$td->FILE => "$top/rules.out",
	      $td->EXIT_STATUS => 0},
	     $td->NORMALIZE_NEWLINES);

$td->runtest("override target",
	     {$td->COMMAND => "abuild -d special",
	      $td->FILTER => "perl $filters/filter-abuild.pl"},
	     {$td->FILE => "$top/rules-override.out",
	      $td->EXIT_STATUS => 0},
	     $td->NORMALIZE_NEWLINES);

cd("work/clean-binding");

$td->runtest("clean binding",
	     {$td->COMMAND => "abuild",
	      $td->FILTER => "perl $filters/filter-abuild.pl"},
	     {$td->FILE => "$top/clean-binding.out",
	      $td->EXIT_STATUS => 0},
	     $td->NORMALIZE_NEWLINES);

cd("work/stdin");

$td->runtest("use System.in",
	     {$td->COMMAND => "echo quack | abuild",
	      $td->FILTER => "grep input:"},
	     {$td->STRING => "input: quack\n",
	      $td->EXIT_STATUS => 0},
	     $td->NORMALIZE_NEWLINES);

check_work_accessed($td);

$td->report(13);
